name: Keep Render Awake

on:
  schedule:
    - cron: "*/5 * * * *"   # 5分おき（UTC）
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Warmup & Ping (robust)
        shell: bash
        run: |
          set -euo pipefail

          BASE="https://zofumixng.onrender.com"
          UA="keepalive-bot/1.0"

          # 共通オプション
          CURL_OPTS=(
            -fsS -4 --location
            --connect-timeout 5      # 接続までの上限
            --max-time 20            # 1回のリクエスト上限
            --retry 4                # 合計 4 回まで
            --retry-all-errors       # DNS/接続含め広くリトライ
            --retry-delay 2
            --retry-max-time 40
            -A "$UA"
          )

          echo "::group::Warmup phase"
          # まず軽いパスを叩いて起こす（gzip済アイコンが最軽量）
          curl "${CURL_OPTS[@]}" "$BASE/favicon.ico" > /dev/null || true
          # さらにトップも1回（起動に時間がかかる実装に備える）
          curl "${CURL_OPTS[@]}" "$BASE/"           > /dev/null || true
          echo "::endgroup::"

          # ちょっと待ってから本命を確認
          sleep 5

          echo "::group::Verify OpenSearch"
          curl "${CURL_OPTS[@]}" "$BASE/opensearch.xml" | grep -q "OpenSearchDescription"
          echo "::endgroup::"
