// ==UserScript==
// @name               ピュアファン
// @description        ワンクリック
// @version            1.1.2
// @license            MIT
// @author             Matthew,人民的勤务员
// @icon               data:image/svg+xml;charset=utf-8;base64,Cjxzdmcgd2lkdGg9IjE5OCIgaGVpZ2h0PSI3MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjE5OCIgaGVpZ2h0PSI3MCIvPgo8cmVjdCB4PSIxMDgiIHk9IjEwIiB3aWR0aD0iODAiIGhlaWdodD0iNTAiIHJ4PSI0IiBmaWxsPSIjZjc5NzFkIi8+Cgo8ZyB0cmFuc2Zvcm09Im1hdHJpeCguMSAwIDAgLjEgODYuODUgMzAuMTUpIiBzdHJva2Utd2lkdGg9IjEwIj4KPHBhdGggZD0ibTg4Ny0zMGMtNS0yLTExLTMtMTctMy0yNC0yLTU0IDctNjggMTlsMy05N2gtNTd2MzAxaDUzdi0xN2MyNSAxNCA0MyAyMSA2NiAyMSA2Ni01IDkzLTY0IDkzLTExNi0xLTUyLTIzLTk3LTczLTEwOHptLTMyIDE3OWMtMzUgMC01MC00MS01MC03M3MxMS02NSA0OC02NSA0OCA0MSA0OCA3MGMwIDMyLTExIDY4LTQ2IDY4em0tMjAwLTg1YzAgMzEtMiA1MC01IDU4LTggMTgtMjQgMjgtNDIgMjktMTgtMS0yNi0xMC0zMy0yMy0yLTctMy0yNi0zLTU2di0xMDBoLTU4djEzOGMtMSA0OSAyNSA4NCA3MyA4NCAyNiAwIDU0LTkgNzItMjh2MjNoNTN2LTIxN2gtNTd6bS0yNDEtOTdjLTI4LTEtNTkgNi03NCAyMHYtOThoLTU3djMwMGg1N3YtMTA5YzAtMTggMi0zMiA1LTQxIDktMTggMjQtMjggNDMtMjggMTYgMCAyNSA4IDMyIDIwIDIgNiAzIDIxIDMgNDR2MTE1aDU4di0xMjhjMC0yMC0xLTM0LTMtNDMtMTItMzQtMzYtNTEtNjQtNTIiLz4KPHBhdGggZD0ibTY4LTQ1Yy0yNC0xLTYzIDgtNzUgMjd2LTIyaC01NnYyMjloNjB2LTEwM2MwLTI2IDItNDMgNS01MyA4LTIwIDI2LTMxIDQ1LTMxIDE4IDAgMjcgOSAzNCAyMyAyIDcgNCAyMyA0IDQ4djExNmg2MHYtMTQyYzAtMTgtMS0zMS0zLTQxLTEwLTM1LTQxLTUwLTc0LTUxem0tMjU3IDI3di0yMmgtNTZ2MjI5aDYwdi03MGMwLTM5IDItNjUgNS03NyA0LTEyIDgtMjEgMTQtMjYgNi00IDEzLTcgMjItNyA4IDAgMTggNCAyOCAxMGwxOS01MmMtMTMtOC0yNi0xMi00MC0xMi0yMCAxLTQwIDEyLTUyIDI3em0tMjA1LTI3Yy0yMiAwLTQyIDUtNjAgMTUtMTkgMTAtMzMgMjQtNDMgNDNzLTE1IDM4LTE1IDU5YzAgMjYgNSA0OCAxNSA2NiAxMCAxOSAyNSAzMyA0NCA0MiAxOSAxMCAzOSAxNCA2MCAxNCAzNCAwIDYyLTExIDg0LTM0IDIzLTIzIDM0LTUxIDM0LTg2IDAtMzQtMTEtNjMtMzMtODUtMjMtMjMtNTEtMzQtODYtMzRtNDAgMTcyYy0xMCAxMi0yNCAxOC0zOSAxOC0xNiAwLTI5LTYtNDAtMThzLTE2LTMwLTE2LTUyYzAtMjMgNS00MCAxNi01MnMyNC0xOCA0MC0xOGMxNSAwIDI5IDYgMzkgMTggMTEgMTIgMTYgMjkgMTYgNTEgMCAyMy01IDQxLTE2IDUzbS0zMTAtMjU0aC0xMDN2MzE2aDY0di0xMTloNDJjNTEgMiAxMDItNiAxMjYtNTEgNy0xMyAxMC0yOSAxMC00OSAwLTQzLTI0LTgxLTYzLTkyLTEyLTMtMzctNS03Ni01em00NyAxMzhjLTkgNC0yNiA1LTUxIDVoLTM1di04OWgzMWMyMyAwIDM4IDAgNDYgMiAyMiA1IDM2IDIyIDM2IDQyLTEgMTktMTEgMzQtMjcgNDAiIGZpbGw9IiNmZmYiLz4KPC9nPgo8L3N2Zz4K
// @match              *://*.pornhub.com/view_video.php?viewkey=*
// @match              *://*.pornhubpremium.com/view_video.php?viewkey=*
// @connect      	   phncdn.com
// @grant        	   GM_setClipboard
// @grant        	   unsafeWindow
// @grant        	   GM_setClipboard
// @grant        	   GM_download
// @grant        	   GM_addStyle
// @downloadURL https://update.sleazyfork.org/scripts/551131/Pure%20Fun%20%E2%80%93%20Pornhub%20Video%20Downloader.user.js
// @updateURL https://update.sleazyfork.org/scripts/551131/Pure%20Fun%20%E2%80%93%20Pornhub%20Video%20Downloader.meta.js
// ==/UserScript==

/**
 * !Matthew modified from the following script. Thanks to heckles and liuwanlin.
 * !This script follows the MIT License. Based on the original author’s work, the code structure and UI have been optimized for a more polished appearance.
 * https://greasyfork.org/zh-CN/scripts/491333
 * https://greasyfork.org/zh-CN/scripts/491329
 * https://sleazyfork.org/en/scripts/528800
 */

(function () {
    'use strict'
    const userLang = (navigator.languages && navigator.languages[0]) || navigator.language || 'en'
    const translations = {
        'en': {
            downloading: 'Downloading...',
            finderror: 'Video download link not found',
            fetcherror: 'Error fetching video, please check the console for details',
            downloadsuccess: 'Download successful',
            downloaderror: 'Error downloading video, please check the console for details',
            downloadfailed: 'Download failed',
            downloadfailed_nosize: 'Unable to retrieve file size',
            copydownloadbtn: 'Copy',
            copysuccess: 'Copy successful',
            downloadbtn: 'Download',
            linkTip: 'Video download URL:'
        },
        'zh-CN,zh,zh-SG': {
            downloading: '下载中...',
            finderror: '未找到视频下载链接',
            fetcherror: '获取视频时出错,请到控制台查看详细信息',
            downloadsuccess: '下载成功',
            downloaderror: '下载视频时出错,请到控制台查看详细信息',
            downloadfailed: '下载失败',
            downloadfailed_nosize: '无法获取文件大小',
            copydownloadbtn: '复制',
            copysuccess: '复制成功',
            downloadbtn: '下载',
            linkTip: '视频下载地址：'
        },
        'zh-TW,zh-HK,zh-MO': {
            downloading: '下載中...',
            finderror: '未找到視頻下載連結',
            fetcherror: '獲取視頻時出錯，請到控制台查看詳細信息',
            downloadsuccess: '下載成功',
            downloaderror: '下載視頻時出錯，請到控制台查看詳細信息',
            downloadfailed: '下載失敗',
            downloadfailed_nosize: '無法獲取文件大小',
            copydownloadbtn: '複製',
            copysuccess: '複製成功',
            downloadbtn: '下載',
            linkTip: '視頻下載地址：'
        },
        'ja': {
            downloading: 'ダウンロード中...',
            finderror: 'ビデオのダウンロードリンクが見つかりません',
            fetcherror: 'ビデオの取得中にエラーが発生しました。詳細はコンソールを確認してください',
            downloadsuccess: 'ダウンロード成功',
            downloaderror: 'ビデオのダウンロード中にエラーが発生しました。詳細はコンソールを確認してください',
            downloadfailed: 'ダウンロード失敗',
            downloadfailed_nosize: 'ファイルサイズを取得できません',
            copydownloadbtn: 'コピー',
            copysuccess: 'コピー成功',
            downloadbtn: 'ダウンロード',
            linkTip: 'ビデオダウンロードURL：'
        }
    }

    const getTranslations = (lang) => {
        for (const key in translations) {
            if (key === lang || key.split(',').includes(lang)) {
                return translations[key];
            }
        }
        return translations['en'];
    }
    const translate = new Proxy(
        function (key) {
            const lang = userLang;
            const strings = getTranslations(lang);
            return strings[key] || translations['en'][key];
        },
        {
            get(target, prop) {
                const lang = userLang;
                const strings = getTranslations(lang);
                return strings[prop] || translations['en'][prop];
            }
        }
    )
    unsafeWindow.translate = translate;
	
	function Toast(msg, duration = 3000, backgroundColor = 'rgba(0, 0, 0, 0.7)', textColor = 'rgb(255, 255, 255)', position = 'bottom-right') {
	    const toast = document.createElement('div');
	    toast.className = 'toast';
	    toast.innerHTML = msg;
	    toast.style.cssText = `
	        max-width: 80%;
	        min-width: 150px;
	        padding: 5px;
	        height: auto;
	        color: ${textColor};
	        line-height: 1.5;
	        text-align: center;
	        border-radius: 5px;
	        position: fixed;
	        z-index: 2147483647;
	        background: ${backgroundColor};
	        font-size: 15px;
	        transition: opacity 0.5s ease-in, transform 0.5s ease-in;
	        word-wrap: break-word;
	    `;
	
	    // 使用位置参数设置位置样式
	    const positions = {
	        'top': 'top: 10%; left: 50%; transform: translate(-50%, 0);',
	        'bottom': 'bottom: 10%; left: 50%; transform: translate(-50%, 0);',
	        'left': 'top: 50%; left: 10%; transform: translate(0, -50%);',
	        'right': 'top: 50%; right: 10%; transform: translate(0, -50%);',
	        'top-left': 'top: 10%; left: 10%; transform: translate(0, 0);',
	        'top-right': 'top: 10%; right: 10%; transform: translate(0, 0);',
	        'bottom-left': 'bottom: 10%; left: 10%; transform: translate(0, 0);',
	        'bottom-right': 'bottom: 10%; right: 10%; transform: translate(0, 0);',
	        'center': 'top: 50%; left: 50%; transform: translate(-50%, -50%);',
	    };
	
	    toast.style.cssText += positions[position] || positions['bottom-right'];
	
	    document.body.appendChild(toast);
	
	    setTimeout(() => {
	        toast.style.opacity = '0';
	        setTimeout(() => document.body.removeChild(toast), 500);
	    }, duration);
	
	    const mediaQuery = `
	        @media only screen and (max-width: 600px) {
	            .toast {
	                font-size: 14px;
	                padding: 10px;
	                max-width: 90%;
	                min-width: 0;
	            }
	        }
	    `;
	    const style = document.createElement('style');
	    style.textContent = mediaQuery;
	    document.head.appendChild(style);
	}

    class VideoParsing {
		
		static addStyle(){
			GM_addStyle(`
			    .download-urls {
			        margin: 15px 0px;
			        padding: 12px;
			        background: #000;
			        border: 1px solid #6f6f6f;
			        border-radius: 5px;
			        font-size: 14px;
			        max-width: 600px;
			    }
				.download-urls h3 {
					margin-bottom: 8px;
					font-size: 16px;
					font-weight: bold;
					color: #333;
				}
			    .download-urls ul {
			        padding: 0;
			        margin: 0;
			        list-style: none;
			    }
			    .download-urls ul li {
			        display: flex;
			        align-items: center;
			        gap: 10px;
			        margin-bottom: 8px;
			    }
			    .download-url-label {
			        flex: 0 0 90px;
			        font-weight: bold;
			        color: #FFF;
			    }
			    .download-url-input {
			        flex: 1;
			        font-size: 12px;
			        padding: 3px 6px;
			        border: 1px solid #ccc;
			        border-radius: 5px;
			        background: #fff;
					color:#000;
			    }
			    .download-url-copy, .download-url-mp4 {
			        padding: 4px 10px;
			        border-radius: 5px;
			        border: none;
			        cursor: pointer;
			        font-size: 12px;
			    }
			    .download-url-copy {
			        background: #eee;
			        color: #333;
			    }
			    .download-url-mp4 {
			        background: #ff9000;
			        color: #fff;
			    }
			    .download-url-copy:hover {
			        background: #ddd;
			    }
			    .download-url-mp4:hover {
			        background: #ffa31a;
			    }
			`);
		}
		
        static getObjectValueByStartsWithChar(obj, char) {
            const vars = []
            Object.keys(obj).forEach(key => {
                if (key.startsWith(char)) {
                    vars.push({
                        key: key,
                        value: obj[key]
                    })
                }
            })
            return vars;
        }

        static getUrlInfo() {
            const flashvars = this.getObjectValueByStartsWithChar(unsafeWindow, 'flashvars_')
            if (!flashvars.length) {
                console.warn(translate.finderror)
                return
            }
            let videosInfo = []
            try {
                videosInfo = flashvars[0]['value']['mediaDefinitions']
            } catch (e) {
                console.error(translate.fetcherror, e)
                return
            }
            let remoteAddress
            let urlInfo = []
            for (let i = 0; i < videosInfo.length; i++) {
                if (videosInfo[i]['remote']) {
                    remoteAddress = videosInfo[i]['videoUrl']
                    break
                }
            }

            if (remoteAddress) {
                const xhr = new XMLHttpRequest()
                xhr.open("GET", remoteAddress, false)
                xhr.onload = function () {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText)
                            if (Array.isArray(data)) {
                                urlInfo = urlInfo.concat(data.map(item => ({
                                    quality: item.quality + '.' + item.format,
                                    url: item.videoUrl
                                })));
                            }
                        } catch (err) {
                            console.error(err)
                        }
                    }
                }
                xhr.send()
            }
            return urlInfo
        }

        static injectUrls2Dom(urlInfo) {
            const container = document.createElement("div");
            container.className = "download-urls";
			
			const title = document.createElement("h3");
			title.textContent = translate.linkTip;
			container.appendChild(title);

			if (urlInfo && urlInfo.length>0){
				const ul = document.createElement("ul");
				urlInfo.forEach(item => {
					const li = document.createElement("li");
				
					const label = document.createElement("span");
					label.className = "download-url-label";
					label.textContent = `[ ${item.quality} ]`;
				
					const input = document.createElement("input");
					input.className = "download-url-input";
					input.value = item.url;
					input.readOnly = true;
				
					const copyBtn = document.createElement("button");
					copyBtn.className = "download-url-copy";
					copyBtn.textContent = translate.copydownloadbtn;
					copyBtn.dataset.href = item.url;
				
					const dlBtn = document.createElement("button");
					dlBtn.className = "download-url-mp4";
					dlBtn.textContent = translate.downloadbtn;
					dlBtn.dataset.href = item.url;
				
					li.appendChild(label);
					li.appendChild(input);
					li.appendChild(copyBtn);
					li.appendChild(dlBtn);
					ul.appendChild(li);
				});
				container.appendChild(ul)
			}
            
			const player = document.querySelector("#player");
			if (player){
				player.insertAdjacentElement("afterend", container);
			}

            const playerWrapper = document.querySelector(".playerWrapper")
            if (playerWrapper){
				playerWrapper.insertAdjacentElement("afterend", container);
			}
        }

        static initEvens() {
            document.addEventListener("click", function (e) {
                if (e.target.classList.contains("download-url-copy")) {
                    e.preventDefault();
                    const url = e.target.dataset.href;
                    GM_setClipboard(url);
					Toast(translate.copysuccess, 3000, 'rgb(18, 219, 18)', '#ffffff', 'top');
                }
            })
        }

        static initDownEvens() {
            document.addEventListener("click", function (e) {
                if (e.target.classList.contains("download-url-mp4")) {
                    e.preventDefault()
                    downloadMp4(e.target.dataset.href, e.target);
                }
            })
        }
		
        static init() {
			this.addStyle();
            this.injectUrls2Dom(this.getUrlInfo())
            this.initEvens()
            this.initDownEvens()
        }
    }
    unsafeWindow.VideoParsing = VideoParsing;
	
	function getHumanReadableSize(sizeb) {
		const sizes = ['B', 'KB', 'MB', 'GB', 'TB']
		const size = sizeb
		let i = parseInt(Math.floor(Math.log(size) / Math.log(1024)))
		const humanReadableSize = (size / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i]
		return humanReadableSize
	}
	function sanitizeTitle() {
		var title = document.title
		title = title.replace(/- Pornhub\.com/, '')
		return title.replace(/[/:*?"<>|]/g, '_').trim();
	}

    async function downloadMp4(videoUrl, element) {
		try {
			const response = await fetch(videoUrl)
			if (!response.ok) {
				element.textContent = translate('downloadfailed');
			}
 
			const contentLength = response.headers.get('Content-Length');
			if (!contentLength) {
				element.textContent = translate('downloadfailed_nosize');
				return;
			}
			const reader = response.body.getReader();
			const totalSize = contentLength ? parseInt(contentLength, 10) : 0;
			let downloadedSize = 0;
			const chunks = [];
			while (true) {
				const { done, value } = await reader.read()
				if (done) break
				downloadedSize += value.length
				chunks.push(value)
				if (totalSize) {
					const progress = ((downloadedSize / totalSize) * 100).toFixed(2)
					element.textContent = `${translate('downloading')} ${progress}% (${getHumanReadableSize(downloadedSize)} / ${getHumanReadableSize(totalSize)})`;
				} else {
					element.textContent = `${translate('downloading')} ${getHumanReadableSize(downloadedSize)}`;
				}
			}
			const blob = new Blob(chunks);
			const url = window.URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.style.display = 'none';
			a.href = url;
			a.download = sanitizeTitle()+".mp4";
			document.body.appendChild(a);
			a.click();
			window.URL.revokeObjectURL(url);
			document.body.removeChild(a);
			Toast(translate('downloadsuccess'), 3000, 'rgb(18, 219, 18)', '#ffffff', 'top');
		} catch (error) {
			Toast(translate('downloaderror'), 3000, 'rgb(173, 7, 7)', '#ffffff', 'top');
			console.error(translate('downloaderror'), error);
		}
    }
    VideoParsing.init()
})();
